name: Scrape ImmoScout24 & Sync Airtable

on:
  schedule:
    # L√§uft t√§glich um 6:00 UTC (7:00 CET / 8:00 CEST)
    - cron: '0 6 * * *'
  
  workflow_dispatch: # Manueller Trigger

jobs:
  scrape-and-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests pyairtable
    
    - name: Run ImmoScout24 Scraper
      run: |
        python immoscout_mobile_api_scraper.py
    
    - name: Check if CSV was created
      run: |
        if [ ! -f immoscout_mutzel.csv ]; then
          echo "‚ùå CSV nicht erstellt - Scraping failed!"
          exit 1
        fi
        echo "‚úÖ CSV erstellt - $(wc -l < immoscout_mutzel.csv) Zeilen"
    
    - name: Sync to Airtable (Chatbot)
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_CHATBOT: ${{ secrets.AIRTABLE_BASE_CHATBOT }}
        AIRTABLE_TABLE_CHATBOT: ${{ secrets.AIRTABLE_TABLE_CHATBOT }}
        AIRTABLE_AUTO_CONFIRM: "true"
      run: |
        python sync_airtable_chatbot.py
    
    - name: Sync to Airtable (Plugin)
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_PLUGIN: ${{ secrets.AIRTABLE_BASE_PLUGIN }}
        AIRTABLE_TABLE_PLUGIN: ${{ secrets.AIRTABLE_TABLE_PLUGIN }}
        AIRTABLE_AUTO_CONFIRM: "true"
      run: |
        python sync_airtable_plugin.py
    
    - name: Upload Images to Airtable
      env:
        AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_PLUGIN: ${{ secrets.AIRTABLE_BASE_PLUGIN }}
        AIRTABLE_TABLE_PLUGIN: ${{ secrets.AIRTABLE_TABLE_PLUGIN }}
      run: |
        python upload_images_to_airtable.py
      continue-on-error: true  # Don't fail if images can't be uploaded
    
    - name: Upload CSV as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: immoscout-data-${{ github.run_number }}
        path: immoscout_mutzel.csv
        retention-days: 7
    
    - name: Commit and push CSV (optional)
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add immoscout_mutzel.csv || true
        git diff --staged --quiet || git commit -m "üìä Update ImmoScout24 data - $(date +'%Y-%m-%d %H:%M')"
        git push || true
      continue-on-error: true
    
    - name: Create Summary
      run: |
        echo "## üìä Scraping Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Properties:** $(tail -n +2 immoscout_mutzel.csv | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **CSV Size:** $(du -h immoscout_mutzel.csv | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Status:** Scraping completed!" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Chatbot Table:** Synced (nur Verf√ºgbar)" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Plugin Table:** Synced (alle Immobilien)" >> $GITHUB_STEP_SUMMARY
        echo "üì∏ **Images:** Uploaded to Airtable Attachments" >> $GITHUB_STEP_SUMMARY
